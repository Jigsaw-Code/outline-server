<!--
  Copyright 2018 The Outline Authors

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<link rel='import' href='../bower_components/polymer/polymer.html'>
<link rel='import' href='../bower_components/iron-pages/iron-pages.html'>

<link rel="import" href="./outline-do-oauth-step.html">
<link rel="import" href="./outline-intro-step.html">
<link rel="import" href="./outline-manual-server-entry.html">
<link rel="import" href="./outline-region-picker-step.html">
<link rel="import" href="./outline-server-progress-step.html">
<link rel="import" href="./cloud-install-styles.html">

<dom-module id="outline-server-creator">
  <template>
    <style include="cloud-install-styles">
      :host {
        display: block;
      }
      .step-header {
        padding: 48px 24px 24px;
        vertical-align: middle;
        height: auto;
        text-align: left;
        background-color: #263238;
      }
      .step-title {
        color: rgba(255, 255, 255, 0.87);
        font-size: 18px;
        line-height: 28px;
        max-width: 75%;
      }
      .step-description {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.54);
        padding: 6px 0;
        max-width: 60%;
      }
</style>
    <paper-card>
      <div id="stepsContainer" class="step-header">
        <div class="step-container first-step" data-step="1">
          <div class="step-title">Choose a server, set up Outline.</div>
          <div class="step-description">Don't have a server? Create an account with DigitalOcean.</div>
        </div>
        <div class="step-container" data-step="2" hidden>
          <div class="step-title">Sign in or create an account with DigitalOcean.</div>
          <div class="step-description">With your account, Outline makes it easy to create a server and get connected.</div>
        </div>
        <div class="step-container" data-step="3" hidden>
          <div class="step-title">Activate you DigitalOcean account.</div>
          <div class="step-description">Once your account is authorized, you can create new servers and start connecting.</div>
        </div>
        <div class="step-container" data-step="4" hidden>
          <div class="step-title">Select the location of your server.</div>
          <div class="step-description">This is where your internet experience will come from.</div>
        </div>
        <div class="step-container" data-step="5" hidden>
          <div class="step-title">Setting up Outline.</div>
          <div class="step-description">This could take up to two minutes. You can destroy this server at anytime.</div>
        </div>
        <div class="step-container" data-step="6" hidden>
          <div class="step-title">Set up Outline on your server.</div>
          <div class="step-description">Follow these instructions to install Outline with a cloud provider or on your own infrastructure.</div>
        </div>
      </div>
    <paper-card>

    <iron-pages id='overlap' attr-for-selected='id' selected='{{ currentPage }}'>
      <outline-intro-step id='intro'></outline-intro-step>
      <outline-do-oauth-step id='digitalOceanOauth'></outline-do-oauth-step>
      <outline-manual-server-entry id='manualEntry'></outline-manual-server-entry>
      <outline-region-picker-step id='regionPicker'></outline-region-picker-step>
      <outline-server-progress-step id='serverProgressStep'></outline-server-progress-step>
    </iron-pages>
  </template>
  <script>
    const SHOW_METRICS_OPT_IN = true;
    Polymer({
      is: 'outline-server-creator',
      stepnumByPage: {
        intro: '1',
        digitalOceanOauth: '2',
        digitalOceanAccountCreated: '3',
        regionPicker: '4',
        serverProgressStep: '5',
        manualEntry: '6'
      },
      properties: {
        currentPage: {
          type: String,
          value: 'intro',
          observer: '_currentPageChanged'
        }
      },
      _currentPageChanged: function (newPage, oldPage) {
        const oldStep = this.stepnumByPage[oldPage];
        const newStep = this.stepnumByPage[newPage];
        const stepChanged = oldStep !== newStep;
        if (!stepChanged || !oldStep) return;
        const steps = Array.from(this.$.stepsContainer.querySelectorAll('.step-container')).reverse();
        for (let step of steps) {
          const stepnum = step.dataset.step;
          step.hidden = stepnum !== newStep;
        }
      },
      _computeCurrentStepClass: function (currentPage) {
        return 'selected-' + currentPage;
      },
      listeners: {
        'RegionSelected': 'handleRegionSelected',
        'MetricsChoiceSelected': 'handleMetricsChoiceSelected',
        'OpenManualServerEntry': 'handleManualServerSelected',
        'ManualServerEntryCancelled': 'handleManualCancelled',
        'DigitalOceanAccountCreated': 'handleDigitalOceanAccountCreated'
      },
      showIntro: function () {
        this.$.overlap.select('intro');
      },
      getAndShowDigitalOceanOauthFlow: function () {
        this.$.overlap.select('digitalOceanOauth');
        const oauthFlow = this.$.digitalOceanOauth;
        oauthFlow.showConnectAccount();
        return oauthFlow;
      },
      getAndShowRegionPicker: function () {
        this.$.overlap.select('regionPicker');
        this.$.regionPicker.init();
        return this.$.regionPicker;
      },
      getManualServerEntry: function() {
        return this.$.manualEntry;
      },
      showProgress: function (serverName, showCancelButton) {
        this.$.overlap.select('serverProgressStep');
        this.$.serverProgressStep.serverName = serverName;
        this.$.serverProgressStep.showCancelButton = showCancelButton;
        this.$.serverProgressStep.start();
      },
      handleRegionSelected: function (e) {
        this.fire('SetUpServerRequested', {
          regionId: this.$.regionPicker.getSelectedRegionId()
        });
      },
      handleManualServerSelected: function() {
        this.$.manualEntry.clear();
        this.$.overlap.select('manualEntry');
      },
      handleManualCancelled: function() {
        this.$.overlap.select('intro');
      },
      handleDigitalOceanAccountCreated: function() {
        const accountCreatedStepnum = this.stepnumByPage['digitalOceanAccountCreated'];
        for (let step of Array.from(this.$.stepsContainer.querySelectorAll('.step-container'))) {
          step.hidden = step.dataset.step !== accountCreatedStepnum;
        }
      },
      stop: function() {
        this.$.serverProgressStep.stop();
      }
    });
  </script>
</dom-module>
