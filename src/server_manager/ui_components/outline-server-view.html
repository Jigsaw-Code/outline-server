<!--
  Copyright 2018 The Outline Authors

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<link rel='import' href='../bower_components/polymer/polymer.html'>
<link rel='import' href='../bower_components/paper-dialog/paper-dialog.html'>
<link rel='import' href='../bower_components/iron-icons/iron-icons.html'>
<link rel='import' href='../bower_components/iron-pages/iron-pages.html'>
<link rel='import' href='../bower_components/iron-icons/editor-icons.html'>
<link rel='import' href='../bower_components/iron-icons/social-icons.html'>
<link rel='import' href='../bower_components/paper-icon-button/paper-icon-button.html'>
<link rel='import' href='../bower_components/paper-item/paper-item.html'>
<link rel='import' href='../bower_components/paper-listbox/paper-listbox.html'>
<link rel='import' href='../bower_components/paper-menu-button/paper-menu-button.html'>
<link rel='import' href='../bower_components/paper-progress/paper-progress.html'>
<link rel='import' href='../bower_components/paper-tabs/paper-tabs.html'>

<link rel='import' href='./cloud-install-styles.html'>
<link rel='import' href='./outline-iconset.html'>
<link rel='import' href='./outline-help-bubble.html'>
<link rel='import' href='./outline-metrics-option-dialog.html'>
<link rel='import' href='./outline-server-settings.html'>
<link rel='import' href='./outline-share-dialog.html'>

<script src='../node_modules.js'></script>

<dom-module id='outline-server-view'>
  <template>
    <style include='cloud-install-styles'></style>
    <style>
     .container {
        display: flex;
        flex-direction: column;
        padding: 24px;
        color: var(--light-gray);
      }
      .tabs-container {
        display: flex;
        flex-direction: row;
        border-bottom: 1px solid var(--border-color);
      }
      .tabs-spacer {
        flex: 2;
      }
      paper-tabs {
        flex: 1;
        --paper-tabs-selection-bar-color: var(--primary-green);
        --paper-tab-ink: var(--primary-green);
        --paper-tab-content-unselected {
          color: var(--dark-gray);
        }
      }
      div[name="connections"], div[name="settings"], .access-key-list {
        margin-top: 24px;
      }
      .server-header {
        display: flex;
        flex-direction: column;
        margin: 24px 0;
      }
      .server-name {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
      .server-name h3 {
        font-size: 36px;
        font-weight: 400;
        color: #FFFFFF;
        flex: 11;
        margin: 0 0 6px 0;
      }
      .server-info {
        color: var(--medium-gray);
      }
      .server-info .server-transfer {
        color: var(--primary-green);
      }
      .access-key-list {
        flex-direction: column;
        padding: 24px 16px 24px 30px;
      }
      .access-key-row {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
      }
      .header-row {
        font-size: 12px;
        color: var(--medium-gray);
        margin-bottom: 12px;
      }
      .header-row paper-button {
        color: white;
        height: 32px;
        font-size: 13px;
        padding: 0 28px 0px 28px;
        background-color: #00bfa5;
        margin: 0px 12px 0px 96px;
        height: 36px;
      }
      .header-row-spacer {
        /* 24px (share icon) + 40px (overflow menu) + 8px (margin) */
        min-width: 72px;
      }
      .measurement-container {
        display: flex;
        flex: 3;
        align-items: center;
      }
      .measurement-container paper-progress {
        height: 3px;
        max-width: 72px;
        margin: 0 24px 0 12px;
        --paper-progress-active-color: var(--primary-green);
        --paper-progress-container-color: var(--light-gray);
      }
      @media (max-width: 640px) {
        .measurement-container paper-progress {
          width: 48px;
        }
      }
      .measurement {
        /* Space the usage bars evenly */
        min-width: 7ch;
        /* We don't want numbers separated from their units */
        white-space: nowrap;
        font-size: 14px;
        color: var(--medium-gray);
        line-height: 24px;
      }
      .access-key-container {
        display: flex;
        flex: 4;
        align-items: center;
      }
      #manager-access-key-description {
        font-size: 12px;
        font-weight: 400;
        margin-top: 4px;
        color: var(--medium-gray);
      }
      .manager-access-key-icon.access-key-icon {
        height: 48px;
      }
      .access-key-icon {
        width: 42px;
        height: 42px;
        margin-right: 18px;
      }
      .access-key-name {
        display: flex;
        flex-direction: column;
        font-weight: 500;
      }
      input.access-key-name {
        font-family: inherit;
        font-size: inherit;
        border-top: none;
        border-left: none;
        border-right: none;
        border-bottom: 1px solid transparent;
        border-radius: 2px;
        padding: 4px 8px;
        position: relative;
        left: -8px; /* Align with padding */
        background: var(--background-contrast-color);
        color: var(--light-gray);
      }
      input.access-key-name::placeholder {
        opacity: inherit;
        color: inherit;
      }
      input.access-key-name:hover {
        border-bottom-color: var(--border-color);
      }
      input.access-key-name:focus {
        border-bottom-color: var(--primary-green);
        border-radius: 0px;
        outline: none;
        font-weight: normal;
      }
      .overflow-menu {
        padding: 0px;
        min-width: 40px;
        margin-left: 8px;
        color: var(--medium-gray);
      }
      .overflow-menu paper-item {
        cursor: pointer;
      }
      paper-item {
        font-size: 14px;
      }
      paper-listbox iron-icon {
        margin-right: 10px;
        width: 18px;
      }
      paper-dropdown {
        box-shadow: 0px 0px 20px #999999;
      }
      #addAccessKeyButton {
        background: var(--primary-green);
        color: #fff;
        border-radius: 50%;
      }
      .actions {
        flex: 1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        text-align: end;
      }
      .connect-button, .share-button {
        color: white;
        padding: 0;
        margin: 0;
        height: 24px;
        width: 24px;
      }
      .add-new-key {
        color: var(--primary-green);
      }
      outline-help-bubble {
        text-align: center;
      }
      outline-help-bubble h3 {
        padding-bottom :0;
        font-weight: 500;
        line-height: 28px;
        font-size: 16px;
        margin: 0px 0px 12px 0px;
      }
      outline-help-bubble paper-button {
        color: white;
      }
      outline-help-bubble img {
        width: 76px;
        height: auto;
        margin: 12px 0px 24px 0px;
      }
      .digital-ocean-icon {
        opacity: 0.54;
      }
      .flex-1 {
        flex: 1;
      }
    </style>

    <div class="container">
      <div class="server-header">
        <div class="server-name">
          <h3>[[serverName]]</h3>
          <paper-menu-button horizontal-align="right" class="overflow-menu flex-1" close-on-activate no-animations dynamic-align no-overlap>
            <paper-icon-button icon="more-vert" slot="dropdown-trigger"></paper-icon-button>
            <paper-listbox slot="dropdown-content">
              <paper-item hidden$="[[!isServerManaged]]" on-tap="deleteServer">
                <iron-icon icon="icons:remove-circle-outline"></iron-icon>Delete server
              </paper-item>
              <paper-item hidden$="[[isServerManaged]]" on-tap="forgetServer">
                <iron-icon icon="icons:remove-circle-outline"></iron-icon>Forget server
              </paper-item>
            </paper-listbox>
          </paper-menu-button>
        </div>
        <div class="server-info">
          <span class="server-transfer">[[_formatBytesTransferred(totalInboundBytes, '0')]] </span>
          <span hidden$="{{!monthlyOutboundTransferBytes}}">of [[_formatBytesTransferred(monthlyOutboundTransferBytes)]] </span>
          <span>transferred</span>
        </div>
      </div>
      <div class="tabs-container">
        <div class="tabs-spacer"></div>
        <paper-tabs selected="{{selectedTab}}" attr-for-selected="name" noink>
          <paper-tab name="connections">Connections</paper-tab>
          <paper-tab name="settings">Settings</paper-tab>
        </paper-tabs>
      </div>

      <iron-pages selected="{{selectedTab}}" attr-for-selected="name">
        <div name="connections">
          <div class="access-key-list card-section">
            <!-- header row -->
            <div class="access-key-row header-row">
              <span class="access-key-container">Access keys</span>
              <span class="measurement-container">Usage / 30 days</span>
              <span class="flex-1 header-row-spacer"></span>
            </div>
            <!-- admin row -->
            <div class="access-key-row" id="managerRow">
              <span class="access-key-container">
                <img class="manager-access-key-icon access-key-icon" src="images/manager-key-avatar.svg">
                <div class="access-key-name">
                  <div>My access key</div>
                  <div id="manager-access-key-description">Connect your devices</div>
                </div>
              </span>
              <span class="measurement-container">
                  <span class="measurement">[[_formatBytesTransferred(myConnection.transferredBytes, "...")]]</span>
                  <paper-progress value='[[myConnection.relativeTraffic]]'></paper-progress>
                </span>
              <span class="actions">
                <span class="flex-1">
                  <paper-icon-button icon="outline-iconset:devices" class="connect-button" on-tap="_handleConnectPressed"></paper-icon-button>
                </span>
                <span class="overflow-menu flex-1"></span>
              </span>
            </div>
            <!-- rows for each access key -->
            <template is="dom-repeat" items="{{accessKeyRows}}" filter="isRegularConnection" sort='sort'>
              <div class="access-key-row">
                <span class="access-key-container">
                  <img class="access-key-icon" src="images/key-avatar.svg">
                  <input type="text" class="access-key-name"
                    placeholder="{{item.placeholderName}}"
                    value="[[item.name]]"
                    on-blur="_handleNameInputBlur"
                    on-keydown="_handleNameInputKeyDown">
                  </input>
                </span>
                <span class="measurement-container">
                  <span class="measurement">[[_formatBytesTransferred(item.transferredBytes, "...")]]</span>
                  <paper-progress value='[[item.relativeTraffic]]'></paper-progress>
                </span>
                <span class="actions">
                  <span class="flex-1">
                    <paper-icon-button icon="outline-iconset:share" class="share-button" on-tap="_handleShareCodePressed"></paper-icon-button>
                  </span>
                  <span class="flex-1">
                    <paper-menu-button horizontal-align="right" class="overflow-menu" close-on-activate no-animations no-overlap dynamic-align>
                      <paper-icon-button icon="more-vert" slot="dropdown-trigger"></paper-icon-button>
                      <paper-listbox slot="dropdown-content">
                      <paper-item on-tap="_handleRenameAccessKeyPressed">
                        <iron-icon icon="icons:create"></iron-icon>Rename
                      </paper-item>
                        <paper-item on-tap="_handleRemoveAccessKeyPressed">
                          <iron-icon icon="icons:delete"></iron-icon>Remove
                        </paper-item>
                      </paper-listbox>
                    </paper-menu-button>
                  </span>
                </span>
              </div>
            </template>
            <!-- add key button -->
            <div class="access-key-row" id="addAccessKeyRow">
              <span class="access-key-container">
                <paper-icon-button icon="icons:add" on-tap='_handleAddAccessKeyPressed' id='addAccessKeyButton' class="access-key-icon"></paper-icon-button>
                <div class="add-new-key">Add new key</div>
              </span>
            </div>
          </div>
        </div>
        <div name="settings">
          <outline-server-settings id="serverSettings" server-id="[[serverId]]" server-hostname="[[serverHostname]]" server-management-port="[[serverManagementPort]]" server-creation-date="[[serverCreationDate]]" server-monthly-cost="[[monthlyCost]]" server-monthly-transfer-limit="[[_formatBytesTransferred(monthlyOutboundTransferBytes)]]" is-server-managed="[[isServerManaged]]" server-location="[[serverLocation]]"></outline-server-settings>
        </div>
      </iron-pages>
    </div>

    <outline-help-bubble id="getConnectedHelpBubble" vertical-align="top" horizontal-align="right">
      <img src="images/connect-tip-2x.png">
      <h3>You are not connected yet!</h3>
      <p>Click here to install the Outline client app, using your personal access key to your Outline server</p>
      <paper-button on-tap="closeGetConnectedHelpBubble">Okay, got it!</paper-button>
    </outline-help-bubble>
    <outline-help-bubble id="addAccessKeyHelpBubble" vertical-align="top" horizontal-align="left">
      <img src="images/key-tip-2x.png">
      <h3>Create keys, share access</h3>
      <p>Share access keys with friends, so they can connect to your Outline server. They can use the same access key on all their devices</p>
      <paper-button on-tap="showGetConnectedHelpBubble">Next</paper-button>
    </outline-help-bubble>

  </template>
  <script>
    const MY_CONNECTION_USER_ID = '0';

    Polymer({
      is: 'outline-server-view',
      created: function () {
        this.bytes = require('bytes');
      },
      properties: {
        serverName: String,
        serverHostname: String,
        serverManagementPort: Number,
        serverCreationDate: String,
        serverLocation: String,
        // myConnection has the same fields as each item in accessKeyRows.  It may
        // be unset in some old versions of Outline that allowed deleting this
        // row.
        myConnection: Object,
        totalInboundBytes: Number,
        accessKeyRows: {type: Array, value: []},
        hasNonAdminAccessKeys: Boolean,
        isServerManaged: Boolean,
        metricsEnabled: Boolean,
        serverId: String,
        // Initialize monthlyOutboundTransferBytes and monthlyCost to 0, so they can
        // be bound to hidden attributes.  Initializing to undefined does not
        // cause hidden$=... expressions to be evaluated and so elements may be
        // shown incorrectly.  See:
        //   https://stackoverflow.com/questions/33700125/polymer-1-0-hidden-attribute-negate-operator
        //   https://www.polymer-project.org/1.0/docs/devguide/data-binding.html
        monthlyOutboundTransferBytes: {type: Number, value: 0},
        monthlyCost: {type: Number, value: 0},
        selectedTab: {
          type: String,
          value: 'connections',
        },
      },
      observers: [
        '_accessKeysAddedOrRemoved(accessKeyRows.splices)',
        '_myConnectionChanged(myConnection)',
        '_selectedTabChanged(selectedTab)',
      ],
      // Parameter `accessKey` has the format {
      //   id: string,
      //   placeholderName: string,
      //   name: string,
      //   accessUrl: string,
      //   transferredBytes: number;
      //   relativeTraffic: number;
      // }
      addAccessKey: function(accessKey) {
        // TODO(fortuna): Restore loading animation.
        // TODO(fortuna): Restore highlighting.
        // Push to array using Polymer in order to propagate changes. See
        // https://www.polymer-project.org/1.0/docs/devguide/model-data#array-mutation
        this.push('accessKeyRows', accessKey);
      },
      removeAccessKey: function(accessKeyId) {
        for (let ui in this.accessKeyRows) {
          if (this.accessKeyRows[ui].id === accessKeyId) {
            this.splice('accessKeyRows', ui, 1);
            return;
          }
        }
      },
      _handleAddAccessKeyPressed: function() {
        this.fire('AddAccessKeyRequested');
        this.$.addAccessKeyHelpBubble.hide();
      },
      _handleNameInputKeyDown: function(event) {
        const input = event.target;
        if (event.key === 'Escape') {
          const accessKey = event.model.item;
          input.value = accessKey.name;
          input.blur();
        } else if (event.key === 'Enter') {
          input.blur();
        }
      },
      _handleNameInputBlur: function(event) {
        const input = event.target;
        const accessKey = event.model.item;
        const displayName = input.value;
        if (displayName === accessKey.name) {
          return;
        }
        input.disabled = true;
        this.fire('RenameAccessKeyRequested', {
          accessKeyId: accessKey.id,
          newName: displayName,
          entry: {
            commitName: () => {
              accessKey.name = displayName;
              input.disabled = false;
            },
            revertName: () => {
              input.value = accessKey.name;
              input.disabled = false;
            }
          }
        });
      },
      _handleRenameAccessKeyPressed: function(event) {
        const input = this.querySelectorAll('.access-key-row.access-key > input')[event.model.index];
        // This need to be deferred because the closing menu messes up with the focus.
        window.setTimeout(() => { input.focus() }, 0);
      },
      _handleConnectPressed: function() {
        this.$.getConnectedHelpBubble.hide();
        this.fire('OpenGetConnectedDialogRequested', {accessKey: this.myConnection.accessUrl});
      },
      _handleShareCodePressed: function(event) {
        const accessKey = event.model.item;
        this.fire('OpenShareDialogRequested', {accessKey: accessKey.accessUrl});
      },
      _handleRemoveAccessKeyPressed: function(e) {
        const accessKey = e.model.item;
        this.fire('RemoveAccessKeyRequested', {accessKeyId: accessKey.id});
      },
      _encodeURIComponent: encodeURIComponent,
      setServerTransferredData(totalBytes) {
        this.totalInboundBytes = totalBytes
      },
      updateAccessKeyRow(accessKeyId, fields) {
        if (accessKeyId === MY_CONNECTION_USER_ID) {
          newAccessKeyRow = Object.assign({}, this.get('myConnection'), fields);
          this.set('myConnection', newAccessKeyRow);
        }
        for (let ui in this.accessKeyRows) {
          if (this.accessKeyRows[ui].id === accessKeyId) {
            newAccessKeyRow = Object.assign({}, this.get(['accessKeyRows', ui]), fields);
            this.set(['accessKeyRows', ui], newAccessKeyRow);
            return;
          }
        }
      },
      _formatBytesTransferred: function(numBytes, emptyValue = '') {
        if (!numBytes) {
          // numBytes may not be set for manual servers, or may be 0 for
          // unused access keys.
          return emptyValue;
        }
        // Show 0 decimals for < 1MB, 1 decimal for >= 1MB, 2 decimals for >= 1GB.
        let numDecimals = 0;
        if (numBytes >= Math.pow(2, 30)) {
          numDecimals = 2;
        } else if (numBytes >= Math.pow(2, 20)) {
          numDecimals = 1;
        }

        const bytesOptions = {unitSeparator: ' ', decimalPlaces: numDecimals};
        // Use uppercase to convert kB to KB (kB incorrectly implies 1000B)
        return this.bytes(numBytes, bytesOptions).toUpperCase();
      },
      _accessKeysAddedOrRemoved: function(changeRecord) {
        // Check for myConnection and regular access keys.
        let hasNonAdminAccessKeys = false;
        for (let ui in this.accessKeyRows) {
          if (this.accessKeyRows[ui].id === MY_CONNECTION_USER_ID) {
            this.myConnection = this.accessKeyRows[ui];
          } else {
            hasNonAdminAccessKeys = true;
          }
        }
        this.hasNonAdminAccessKeys = hasNonAdminAccessKeys;
      },
      _myConnectionChanged: function(myConnection) {
        if (!myConnection) {
          this.$.getConnectedHelpBubble.hide();
        }
      },
      showGetConnectedHelpBubble: function() {
        if (this.myConnection) {
          this.$.addAccessKeyHelpBubble.hide();
          this.showHelpBubbleOnce('getConnectedHelpBubble', 'managerRow');
        }
      },
      closeGetConnectedHelpBubble: function() {
        this.$.getConnectedHelpBubble.hide();
      },
      _selectedTabChanged(selectedTab) {
        if (this.selectedTab === 'settings') {
          this.$.serverSettings.update(this.serverName, this.metricsEnabled);
        }
      },
      // initHelpBubbles should be called after this outline-server-view
      // is on the screen (e.g. selected in iron-pages).  If help bubbles
      // are initialized before this point, setPosition will not work and
      // they will appear in the top left of the view.
      initHelpBubbles: function() {
        this.showHelpBubbleOnce('addAccessKeyHelpBubble', 'addAccessKeyRow', 'up', 'left');
      },
      showHelpBubbleOnce: function(helpBubbleId, positionTargetId,
                                   arrowDirection='up', arrowAlignment='right') {
        const storageKey = helpBubbleId + '-dismissed';
        if (window.localStorage.getItem(storageKey)) {
          // Help bubble has already been dismissed, nothing to show.
          return;
        }
        const helpBubble = this.$[helpBubbleId];
        helpBubble.show(this.$[positionTargetId], arrowDirection, arrowAlignment);
        helpBubble.addEventListener('outline-help-bubble-dismissed', function(e) {
          window.localStorage.setItem(storageKey, true);
        }.bind(this));
      },
      isRegularConnection: function(item) {
        return item.id !== MY_CONNECTION_USER_ID;
      },
      // https://stackoverflow.com/a/46119203/1298144
      sort: function(a, b) {
        var nameA = a.name.toUpperCase(); 
        var nameB = b.name.toUpperCase(); 
        if (nameA < nameB) {
          return -1;
        }
        if (nameA > nameB) {
          return 1;
        }

        // names must be equal
        return 0;
      },
      deleteServer: function() {
        this.fire('DeleteServerRequested');
      },
      forgetServer: function() {
        this.fire('ForgetServerRequested');
      }
    });
  </script>
</dom-module>
